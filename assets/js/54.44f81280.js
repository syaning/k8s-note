(window.webpackJsonp=window.webpackJsonp||[]).push([[54],{364:function(t,a,e){"use strict";e.r(a);var s=e(42),n=Object(s.a)({},(function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"serviceaccount"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#serviceaccount"}},[t._v("#")]),t._v(" ServiceAccount")]),t._v(" "),e("p"),e("div",{staticClass:"table-of-contents"},[e("ul",[e("li",[e("a",{attrs:{href:"#简介"}},[t._v("简介")])]),e("li",[e("a",{attrs:{href:"#创建-serviceaccount"}},[t._v("创建 ServiceAccount")])]),e("li",[e("a",{attrs:{href:"#使用-serviceaccount"}},[t._v("使用 ServiceAccount")])]),e("li",[e("a",{attrs:{href:"#添加-imagepullsecret"}},[t._v("添加 imagePullSecret")])]),e("li",[e("a",{attrs:{href:"#参考"}},[t._v("参考")])])])]),e("p"),t._v(" "),e("h2",{attrs:{id:"简介"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#简介"}},[t._v("#")]),t._v(" 简介")]),t._v(" "),e("p",[t._v("ServiceAccount 是为 Pod 内的进程调用集群的 API 所使用的，是与 namespace 绑定的。")]),t._v(" "),e("p",[t._v("每个 namespace 创建的时候，会默认创建一个 default 的 ServiceAccount，每个 ServiceAccount 创建的时候，会默认创建一个类型为 "),e("code",[t._v("kubernetes.io/service-account-token")]),t._v(" 的 Secret。")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ kubectl create ns "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v("\n\n$ kubectl get sa -n "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v("\nNAME      SECRETS   AGE\ndefault   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("         48s\n\n$ kubectl get sa -n "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v(" default -oyaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  creationTimestamp: "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2019-08-25T14:26:16Z"')]),t._v("\n  name: default\n  namespace: "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v("\n  resourceVersion: "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"116679"')]),t._v("\n  selfLink: /api/v1/namespaces/test/serviceaccounts/default\n  uid: 4c51e386-c744-11e9-b46c-025000000001\nsecrets:\n- name: default-token-6wgrh\n\n$ kubectl get secret -n "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v("\nNAME                  TYPE                                  DATA   AGE\ndefault-token-6wgrh   kubernetes.io/service-account-token   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("      83s\n\n$ kubectl get secret -n "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v(" default-token-6wgrh -oyaml\napiVersion: v1\ndata:\n  ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n  namespace: "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("dGVzdA")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v("\n  token: ZXlKaGJHY2lPaUpTVXpJMU5pSX"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\nkind: Secret\nmetadata:\n  annotations:\n    kubernetes.io/service-account.name: default\n    kubernetes.io/service-account.uid: 4c51e386-c744-11e9-b46c-025000000001\n  creationTimestamp: "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2019-08-25T14:26:16Z"')]),t._v("\n  name: default-token-6wgrh\n  namespace: "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v("\n  resourceVersion: "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"116678"')]),t._v("\n  selfLink: /api/v1/namespaces/test/secrets/default-token-6wgrh\n  uid: 4c586a91-c744-11e9-b46c-025000000001\ntype: kubernetes.io/service-account-token\n")])])]),e("p",[t._v("Pod 创建的时候，会默认使用当前 namespace 下 default 的 ServiceAccount，并且将其对应的 Secret 挂载到容器的 "),e("code",[t._v("/var/run/secrets/kubernetes.io/serviceaccount")]),t._v(" 下。")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ kubectl describe po nginx-66f9f9cfd5-64ht8 -n "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v("\nName:               nginx-66f9f9cfd5-64ht8\nNamespace:          "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v("\nContainers:\n  nginx:\n    Container ID:   docker://5d84cb88a19db3390a924f85da507b24c449f9c18bf8ba49e7899eb00b87fc72\n    Image:          nginx:1.16\n    Port:           "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("/TCP\n    Mounts:\n      /var/run/secrets/kubernetes.io/serviceaccount from default-token-6wgrh "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ro"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nVolumes:\n  default-token-6wgrh:\n    Type:        Secret "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a volume populated by a Secret"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    SecretName:  default-token-6wgrh\n    Optional:    "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n\n$ kubectl get po nginx-66f9f9cfd5-64ht8 -n "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v(" -oyaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: nginx-66f9f9cfd5-64ht8\n  namespace: "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v("\nspec:\n  containers:\n  - image: nginx:1.16\n    name: nginx\n    ports:\n    - containerPort: "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n      protocol: TCP\n    volumeMounts:\n    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount\n      name: default-token-6wgrh\n      readOnly: "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n  serviceAccount: default\n  serviceAccountName: default\n  volumes:\n  - name: default-token-6wgrh\n    secret:\n      defaultMode: "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("420")]),t._v("\n      secretName: default-token-6wgrh\n")])])]),e("h2",{attrs:{id:"创建-serviceaccount"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#创建-serviceaccount"}},[t._v("#")]),t._v(" 创建 ServiceAccount")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ kubectl create sa test-sa\n")])])]),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ServiceAccount\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("sa\n")])])]),e("h2",{attrs:{id:"使用-serviceaccount"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用-serviceaccount"}},[t._v("#")]),t._v(" 使用 ServiceAccount")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" apps/v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Deployment\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("selector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("matchLabels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("template")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("serviceAccountName")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("sa\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.16")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containerPort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n")])])]),e("p",[t._v("ServiceAccount 通常会和 Role 或者 ClusterRole 进行绑定，从而被赋予一定的权限，例如读取 Pod 信息等。详情查看 "),e("RouterLink",{attrs:{to:"/k8s/guides/rbac.html"}},[t._v("RBAC")]),t._v("。")],1),t._v(" "),e("h2",{attrs:{id:"添加-imagepullsecret"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#添加-imagepullsecret"}},[t._v("#")]),t._v(" 添加 imagePullSecret")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ kubectl create secret docker-registry private-registry "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    --docker-username"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("admin "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    --docker-password"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("admin "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    --docker-email"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("admin@example.com "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    --docker-server"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("https://127.0.0.1:5000\n\n$ kubectl create sa test-sa\n\n$ kubectl patch sa test-sa -p "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'{"imagePullSecrets": [{"name": "private-registry"}]}\'')]),t._v("\n\n$ kubectl get sa test-sa -oyaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: test-sa\n  namespace: default\nsecrets:\n- name: test-sa-token-pmk8t\nimagePullSecrets:\n- name: private-registry\n")])])]),e("p",[t._v("然后之后创建的 Pod 就会自动带上指定的 "),e("code",[t._v("imagePullSecrets")]),t._v("：")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[t._v("$ kubectl get po nginx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("7988dffbf"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("svfvh "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("oyaml\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Pod\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("7988dffbf"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("svfvh\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" default\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.16")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("imagePullSecrets")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" private"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("registry\n")])])]),e("h2",{attrs:{id:"参考"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[t._v("#")]),t._v(" 参考")]),t._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Configure Service Accounts for Pods"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://kubernetes.io/docs/reference/access-authn-authz/service-accounts-admin/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Managing Service Accounts"),e("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=n.exports}}]);